---
title: "Complexity Challenge"
author: "Simon Crase"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    fig_caption: yes
    number_sections: true
    keep_tex: true
bibliography: 201804.bib
csl: ieee-with-url.csl

---
\fontfamily{cmr}
\fontsize{12}{22}
\fontseries{b}
\selectfont

```{r setup, include=FALSE,echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source('get-data.r')
endrun.data<-get.tau(file.name="take2 experiment-table-new.csv")
n.repetitions<-get.n.repetitions(endrun.data)
netlogo.data<-read.nlogo.experiment(file.name='take2 experiment-table-new.csv')
```

# Introduction
The Santa Fe Institute Spring 2018 Challenge[@Challenge:2018] models the behaviour of investors choosing between three pools, one providing a stable income stream, and two others offering potentially higher, but risky returns. Since each investor has access to historical data --- their own choices and payoffs, and aggregate data for each pool --- the Challenge can be interpreted as a simple model of Technical Analysis[@romero2014hedge, pp. 32]. At the start of this investigation, I expected that simulation would support the weak form of the Efficient Market Hypothesis [@romero2014hedge, ch. 8]: "future asset prices \emph{cannot} be predicted using historical price and volume data".

# Background

Brian Arthur [@arthur1994inductive] investigated the behaviour of people deciding whether or not to visit the El Farol Bar in Santa Fe, guided only be historical attendance data. The El Farol problem assumes that the visit would be enjoyable if 60 or fewer people attended. Arthur discovered there is no rational solution: if an algorithm existed to predict attendance accurately, either everyone would attend, or nobody would, falsifying the prediction. Instead he modelled Bounded Rationality by equipping each person with a bag of fixed strategies for estimating attendance. A simple machine learning method replaces poorly performing strategies with ones that have proven more accurate on recent data.


The El Farol problem can be generalized to the Minority game [@challet1997emergence].

# Methods


I developed a model, _testbed.nlogo_, using Netlogo, [@Wilensky:1999]. I followed the approach of [@arthur1994inductive], using a "bag of strategies" to assign agents to pools. The strategies include stay in pool, jump at random, and estimate length to select pool offering the best likely return. Each agent kept track of the performance of the strategies in its bag, and replaced them if they are not doing well. The limitation of this  approach is that no new stratigies can arise. Subsequently I adopted the approach of Fogel [@fogel1999inductive], using a genetic algorithm that breeds autoregressive models. My model represents Investors and Pools as Breeds of Turtles. Investors are connected to Pools by Links as shown in Figure \ref{fig:ui}.

![Investors are linked to Pools: a happy face represents a pool that has paid out, colours represent risk in a natural way (traffic lights), and the size of each fish correlates to the wealth of an investor.\label{fig:ui}](View.jpg){ width=50%, height=50% }

The model was executed by the BehaviourSpace tool of Netlogo, which performed `r n.repetitions` repetitions, varying the parameters listed in Table \ref{table:configs}. I used R to analyze the data, and an RMarkdown script to present the results, following the excellent advice of Rosanna van Hespen[@vanhespen2016thesis]. 

```{r echo=FALSE,results='asis'}
library(knitr)
kable(get.netlogo.params(netlogo.data),
      col.names=c("Name","Range"),
      caption="\\label{table:configs}Parameters varied by BehaviourSpace")

```

#Results



##Behaviours


What general behaviors arise in this system?  How does the wealth of the agents change over time? At the aggregate level? At the individual level?

Figures \ref{fig:plot_wealth0} and \ref{fig:plot_wealth1} illustrate the growth of wealth, over a range of values for $\tau$, and for the number of coefficients in predictors, and the number of predictors in the pool. Figures \ref{fig:plot_outgoings0} and \ref{fig:plot_outgoings1} show the return per investor in each pool: notice that they tend to stablize with returns that are roughly comparable. Figures \ref{fig:plot_sq0} and \ref{fig:plot_sq1} show the squared error of the best predictor in each pool. Each figure is plotted using data from `r n.repetitions` separate runs of the model.

```{r echo=FALSE,fig.cap="\\label{fig:plot_wealth0}Variation of Wealth with number of coefficients and number of predictors, for $\\tau=0$",warning=FALSE, out.width='.49\\linewidth', fig.width=4, fig.height=4,fig.show='hold',fig.align='center',fig.pos = 'p'}
plot.wealth(netlogo.data,tau=0)
plot.wealth(netlogo.data,tau=0,n_coefficients = 6)
plot.wealth(netlogo.data,tau=0,n_predictors  = 6)
plot.wealth(netlogo.data,tau=0,n_coefficients = 6,n_predictors  = 6)
plot.wealth(netlogo.data,tau=0,n_coefficients = 9,n_predictors  = 9)
```

```{r echo=FALSE,fig.cap="\\label{fig:plot_wealth1}Variation of Wealth with number of coefficients with number of predictors, for $\\tau=1$",warning=FALSE, out.width='.49\\linewidth', fig.width=4, fig.height=4,fig.show='hold',fig.align='center',fig.pos = 'p'}
plot.wealth(netlogo.data,tau=1)
plot.wealth(netlogo.data,tau=1,n_coefficients = 6)
plot.wealth(netlogo.data,tau=1,n_predictors  = 6)
plot.wealth(netlogo.data,tau=1,n_coefficients = 6,n_predictors  = 6)
plot.wealth(netlogo.data,tau=1,n_coefficients = 9,n_predictors  = 9)
```

```{r echo=FALSE,fig.cap="\\label{fig:plot_outgoings0}Variation of Payout with number of coefficients and number of predictors, for $\\tau=0$",warning=FALSE, out.width='.49\\linewidth', fig.width=4, fig.height=4,fig.show='hold',fig.align='center',fig.pos = 'p'}
plot.outgoings(netlogo.data,tau=0)
plot.outgoings(netlogo.data,tau=0,n_coefficients = 6)
plot.outgoings(netlogo.data,tau=0,n_predictors  = 6)
plot.outgoings(netlogo.data,tau=0,n_coefficients = 6,n_predictors  = 6)
plot.outgoings(netlogo.data,tau=0,n_coefficients = 9,n_predictors  = 9)
```

```{r echo=FALSE,fig.cap="\\label{fig:plot_outgoings1}Variation of Payout with number of coefficients with number of predictors, for $\\tau=1$",warning=FALSE, out.width='.49\\linewidth', fig.width=4, fig.height=4,fig.show='hold',fig.align='center',fig.pos = 'p'}
plot.outgoings(netlogo.data,tau=1)
plot.outgoings(netlogo.data,tau=1,n_coefficients = 6)
plot.outgoings(netlogo.data,tau=1,n_predictors  = 6)
plot.outgoings(netlogo.data,tau=1,n_coefficients = 6,n_predictors  = 6)
plot.outgoings(netlogo.data,tau=1,n_coefficients = 9,n_predictors  = 9)
```

```{r echo=FALSE,fig.cap="\\label{fig:plot_sq0}Variation of Error with number of coefficients and number of predictors, for $\\tau=0$",warning=FALSE, out.width='.49\\linewidth', fig.width=4, fig.height=4,fig.show='hold',fig.align='center',fig.pos = 'p'}
plot.errors(netlogo.data,tau=0)
plot.errors(netlogo.data,tau=0,n_coefficients = 6)
plot.errors(netlogo.data,tau=0,n_predictors  = 6)
plot.errors(netlogo.data,tau=0,n_coefficients = 6,n_predictors  = 6)
plot.errors(netlogo.data,tau=0,n_coefficients = 9,n_predictors  = 9)
```

```{r echo=FALSE,fig.cap="\\label{fig:plot_sq1}Variation of Error with number of coefficients with number of predictors, for $\\tau=1$",warning=FALSE, out.width='.49\\linewidth', fig.width=4, fig.height=4,fig.show='hold',fig.align='center',fig.pos = 'p'}
plot.errors(netlogo.data,tau=1)
plot.errors(netlogo.data,tau=1,n_coefficients = 6)
plot.errors(netlogo.data,tau=1,n_predictors  = 6)
plot.errors(netlogo.data,tau=1,n_coefficients = 6,n_predictors  = 6)
plot.errors(netlogo.data,tau=1,n_coefficients = 9,n_predictors  = 9)
```

```{r echo=FALSE,fig.cap="\\label{fig:plot_individual01}Growth of wealth",warning=FALSE, out.width='.49\\linewidth', fig.width=4, fig.height=4,fig.show='hold',fig.align='center',fig.pos = 'p'}
my.individual.details<-read.csv('C:/Users/Weka/201804/Experiments/details-tau0.csv')
plot.individuals(my.individual.details,my.strategy=1,n=5)
plot.individuals(my.individual.details,my.strategy=0,n=5)
my.individual.details<-read.csv('C:/Users/Weka/201804/Experiments/details-tau1.csv')
plot.individuals(my.individual.details,my.strategy=1,n=5)
plot.individuals(my.individual.details,my.strategy=0,n=5)
```

```{r echo=FALSE,fig.cap="\\label{fig:plot_individual25}Growth of wealth",warning=FALSE, out.width='.49\\linewidth', fig.width=4, fig.height=4,fig.show='hold',fig.align='center',fig.pos = 'p'}
my.individual.details<-read.csv('C:/Users/Weka/201804/Experiments/details-tau2.csv')
plot.individuals(my.individual.details,my.strategy=1,n=5)
plot.individuals(my.individual.details,my.strategy=0,n=5)
my.individual.details<-read.csv('C:/Users/Weka/201804/Experiments/details-tau5.csv')
plot.individuals(my.individual.details,my.strategy=1,n=5)
plot.individuals(my.individual.details,my.strategy=0,n=5)
```

##Diversity

How does the diversity of strategies influence the dynamics of the system?

##Behaviours

Are there generally classes of agent behavior (say, based on what data they use, how they process it, or the agent's overall sophistication) that lead to better performance?

##Violate Assumptions

What happens to the system if you violate one of the original assumptions of the problem and allow the agents to alter their strategies over time by observing the performance and strategic details of the other agents?

##Meta-Agents

Suppose that meta-agents exist that can coordinate the behaviors of a subset of the agents (and split the resulting payoffs equally across the subset)---how does this impact the system's behavior?

##Changes

### Variation of $\tau$

Figure \ref{fig:tau_wealth} shows the effect of varying $\tau$. Paradoxically total wealth increases with $\tau$. Figure \ref{fig:tau_error} shows that the transients in the total error are damped when $\tau>0$, but persist for $\tau=0$. Presumably $\tau$ discourages agents from jumping from pool to pool.

```{r plot_wealth, echo=FALSE,fig.cap="\\label{fig:tau_wealth}Variation of accumulated wealth with $\\tau$",warning=FALSE, out.width='.49\\linewidth', fig.width=4, fig.height=4,fig.show='hold',fig.align='center',fig.pos = 'p'}
endrun.data<-get.tau()

tau.agg11 <- extract.wealth.vs.tau(endrun.data,can_borrow=TRUE,randomize_step=TRUE)
plot(tau.agg11$tau,tau.agg11$mean__wealth__of_investors,type="l",col="blue",lty=1,
     xlab="tau",ylab="",yaxt='n',main = "Mean Wealth")
par(new=TRUE)
tau.agg12 <- extract.wealth.vs.tau(endrun.data,can_borrow=TRUE,randomize_step=FALSE)
plot(tau.agg12$tau,tau.agg12$mean__wealth__of_investors,type="l",col="magenta",lty=2,
     xlab="",ylab="",yaxt='n')
par(new=TRUE)
tau.agg21 <- extract.wealth.vs.tau(endrun.data,can_borrow=FALSE,randomize_step=TRUE)
plot(tau.agg21$tau,tau.agg21$mean__wealth__of_investors,type="l",col="slategray",lty=6,
     xlab="",ylab="",yaxt='n')
par(new=TRUE)
tau.agg22 <- extract.wealth.vs.tau(endrun.data,can_borrow=FALSE,randomize_step=FALSE)
plot(tau.agg22$tau,tau.agg22$mean__wealth__of_investors,type="l",col="steelblue",lty=4,
     xlab="",ylab="",yaxt='n')
legend("bottomright", legend=c("TT", "FT","TF","FF"),
       col=c("blue", "magenta","slategrey","steelblue"), lty=c(1,2,6,4), cex=0.8)

plot(tau.agg11$tau,tau.agg11$standard_deviation__wealth__of_investors,type="l",col="blue",lty=1,
     xlab="tau",ylab="",yaxt='n',main="Standard Deviation")
par(new=TRUE)
plot(tau.agg12$tau,tau.agg12$standard_deviation__wealth__of_investors,type="l",col="magenta",lty=2,
     xlab="",ylab="",yaxt='n')
par(new=TRUE)
plot(tau.agg21$tau,tau.agg21$standard_deviation__wealth__of_investors,type="l",col="slategray",lty=6,
     xlab="",ylab="",yaxt='n')
par(new=TRUE)
plot(tau.agg22$tau,tau.agg22$standard_deviation__wealth__of_investors,type="l",col="black",lty=5,
     xlab="",ylab="",yaxt='n')
```



```{r plot_errors, echo=FALSE,fig.cap="\\label{fig:tau_error}Variation of Error with $\\tau$",warning=FALSE, out.width='.49\\linewidth', fig.width=4, fig.height=4,fig.show='hold',fig.align='center',fig.pos = 'p'}
dd<-read.nlogo.experiment()
zz0<-extract.errors.vs.tau(dd)
aa0<-aggregate(zz0,by=list(zz0$X_step_),FUN=mean,na.rm=TRUE)
zz1<-extract.errors.vs.tau(dd,tau=1)
aa1<-aggregate(zz1,by=list(zz1$X_step_),FUN=mean,na.rm=TRUE)
zz5<-extract.errors.vs.tau(dd,tau=5)
aa5<-aggregate(zz5,by=list(zz5$X_step_),FUN=mean,na.rm=TRUE)


plot(aa0$X_step_,aa0$mean__sum_squares_error__of_investors,type="l",col="blue",lty=1,xlab="Step",ylab="",yaxt='n',main="Variation of Squared error")
legend("topright", legend=c("tau=0", "tau=1","tau=5"),
       col=c("blue", "magenta","slategrey"), lty=c(1,2,6), cex=0.8)
par(new=TRUE)
plot(aa1$X_step_,aa1$mean__sum_squares_error__of_investors,type="l",col="magenta",lty=2,xlab="",ylab="",yaxt='n')
par(new=TRUE)
plot(aa5$X_step_,aa5$mean__sum_squares_error__of_investors,type="l",col="slategray",lty=6,xlab="",ylab="",yaxt='n')


```

###   you change the total number of agents in the world?

#Discussion

#Acknowledgements

I wish to thank the SFI staff and mentors, and my fellow students for friendly and helpful discussions and recommended reading.

#References
 
 


